# simple CMP client

This is a simple CMP client based on gencmpclient. In the next steps it should be extracted from the fork,
and libgencmp should be used (it already uses only the public API of the component), but for pace needed
for PoC, I used the build infrastructure already provided by gencmpclient.

original gencmpclient [README](gencmp_README.md)

## Build steps

Don't forget to get submodules
`git submodule update --init --recursive`

Build
`make -f Makefile_v1`

Clean
`make -f Makefile_v1 clean`

## Running

To access help `./cmpClient -h`

It will show:
```
$ ./cmpClient -h
Usage: ./cmpClient [-h] -c [ir|kur] [-m mac_string] [--sn serial_number_string]
Options:
  -h                          Print helpt              (Optional)
  -c [ir|kur]                 Command IR or KUR        (Required)
  -m mac_string               MAC address string       (Optional, default: 00:08:DC:74:43:DA)
  -s serial_number_string     Serial number string     (Optional, default: IPS-601-25GW-07196)
```

Command IR and KUR are supported and they are required arguments.

Examples:

`./cmpClient -c ir`
`./cmpClient -c kur`

Timeout might happen, so just restart the request.

## Configuration

Configuration files used by `gencmpclient` and `libsecutils` are supported and required. Currently hardcoded is `config/demo.cnf` and besides the general settings, 
`CloudCA`, `imprint` and `update` sections are in use.

From the original, following fields are changed:

`[CloudCA] recipient` is changed to `/CN=SE-CloudPKI-Integration-Test`.

`[CloudCA] cacert` is changed to `creds/test/GasandPowerIoTRoot.crt`.

`[CloudCA] out_trusted` is removed.

`[CloudCA] ref` is changed to `"/CN=Sensproducts DevLab LRA"`

`[CloudCA] secret` is changed to `pass:Random1234`

`[CloudCA] subject` is changed to `"/unstructuredAddress=00:08:DC:74:43:DA/CN=Sensformer V1/serialNumber=IPS-601-25GW-07196/OU=Quality System - For Test purpose only/O=Siemens/C=DE"`,
but it not used from the config. In fact if needed we could provide other values differently as well.

`[imprint] newkeytype` is changed to `rsa:4096`, but the value is also not used.`

`[update] cert` is changed to `$imprint::certout`.

`[update] key` is changed to `$imprint::newkey`.

`[update] keypass` is changed to `$imprint::newkeypass`.

`[update] newkey` is changed to `$imprint::newkey`.

`[update] newkeypass` is changed to `$imprint::newkeypass`.

`[update] reqexts` is empty.

`[update] policies` is empty.

`[update] subject` is empty.

`[update] oldcert` is changed to `$imprint::certout`.

`[update] implicit_confirm` is changed to `1`.

`[update] certout` is changed to `$imprint::certout`.

## Saving CMP message to a DER file and sending a CMP from a DER file

In the original client to be able to save a generated CMP message to file, you need to use `-reqout` flag. Example (for sending an IR message):
`$ no_proxy=localhost,127.0.0.1 LD_LIBRARY_PATH="." ./cmpClient imprint -section CloudCA -path "/.well-known/cmp"/p/PPKI%20QA"" -reqexts empty -reqout ir_cmp.der`

To be able to restore the `ir_cmp.der` and send it a `-reqin` flag is used:
`$ no_proxy=localhost,127.0.0.1 LD_LIBRARY_PATH="." ./cmpClient imprint -section CloudCA -path "/.well-known/cmp"/p/PPKI%20QA"" -reqexts empty -reqin ir_cmp.der -newkeytype ""  -newkey creds/manufacturer.pem`

It is worth noting that `-newkeytype` is set to empty value to avoid regenerating it and as `-newkey`, a key generated by the IR step is used. 

## Usage of libgencmp API

The main libgencmp calls used are:

* `CMPclient_init` that initializes the OpenSSL library and some internals.
* `CMPclient_prepare` that prepares the client for the CMP communication.
* `CMPclient_setup_HTTP` that sets up the HTTP connection.
* `CMPclient_imprint` that performs the whole IR messaging (IR, IP, CERTCONF, PKICONF).
* `CMPclient_update_anycert` that perform the whole KUR messaging (KUR, KUP).

However, the libgencmp API is not standalone and relies heavily on `libsecutils` for preparation.  The details about the usage and the workflow is directly in the code comments.

The most interesting part is in the `src/cmpClient.c`: `main` function, and wrappers `cmp_ir`, and `cmp_kur` functions.

## Disclaimer

This software including associated documentation is provided ‘as is’.
Effort has been spent on quality assurance, but there are no guarantees.


## License

This work is licensed under the terms of the Apache Software License 2.0.
See the [LICENSE.txt](LICENSE.txt) file in the top-level directory.

SPDX-License-Identifier: Apache-2.0
